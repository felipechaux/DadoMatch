# frozen_string_literal: true

default_platform(:android)

platform :android do
  # ──────────────────────────────────────────
  # Build a signed release AAB
  # ──────────────────────────────────────────
  desc "Build a signed release AAB"
  lane :build do
    gradle(
      task: "clean bundle",
      build_type: "Release",
      project_dir: "./",
      print_command: true,
      properties: {
        "appFlavor" => ENV["APP_FLAVOR"] || "production"
      }
    )
  end

  # ──────────────────────────────────────────
  # Upload to Internal Testing track
  # ──────────────────────────────────────────
  desc "Upload to Google Play Internal Testing"
  lane :internal do
    build  # always build fresh before uploading
    project_root = File.expand_path("..", __dir__)
    upload_to_play_store(
      track: "internal",
      package_name: "com.chauxdevapps.dadomatch",
      aab: File.join(project_root, "app/build/outputs/bundle/release/app-release.aab"),
      json_key: File.join(project_root, "app/play-service-account.json"),
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
    )
  end

  # ──────────────────────────────────────────
  # Upload to Alpha (Closed Testing) track
  # ──────────────────────────────────────────
  desc "Upload to Google Play Closed Testing (Alpha)"
  lane :beta do
    build  # always build fresh before uploading
    project_root = File.expand_path("..", __dir__)
    upload_to_play_store(
      track: "alpha",
      package_name: "com.chauxdevapps.dadomatch",
      aab: File.join(project_root, "app/build/outputs/bundle/release/app-release.aab"),
      json_key: File.join(project_root, "app/play-service-account.json"),
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
    )
  end

  # ──────────────────────────────────────────
  # Promote Internal → Production
  # ──────────────────────────────────────────
  desc "Promote Internal Testing release to Production"
  lane :production do
    project_root = File.expand_path("..", __dir__)
    upload_to_play_store(
      track: "internal",
      track_promote_to: "production",
      json_key: File.join(project_root, "app/play-service-account.json"),
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
    )
  end

  # ──────────────────────────────────────────
  # CI helper: load local.properties into ENV
  # ──────────────────────────────────────────
  before_all do
    # Load signing props from local.properties when not already set
    # (e.g. on a developer's machine; CI should inject ENV vars directly)
    props_file = File.join(Dir.pwd, "local.properties")
    if File.exist?(props_file)
      File.readlines(props_file).each do |line|
        next if line.strip.start_with?("#") || line.strip.empty?
        key, value = line.strip.split("=", 2)
        ENV[key] ||= value if key && value
      end
    end
  end
end
